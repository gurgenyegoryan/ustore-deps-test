name: Release

on:
  push:
    branches: ["main-dev"]

env:
  BUILD_TYPE: Release
  GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
  

permissions:
  contents: write
  pages: write
  id-token: write


jobs:
  build_arm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        persist-credentials: false
        ref: 'main-dev'

    - name: arm-none-eabi-gcc
      uses: ryanwinter/arm-none-eabi-gcc@master
      with:
        release: 10.3-2021.10

    - run: |
        sudo apt install -y python3 python3-dev python3-pip build-essential cmake git
          git clone https://github.com/unum-cloud/ustore.git
          cd ustore/ && git checkout main-dev && git submodule update --init --recursive
          python -m pip install --force-reinstall conan==1.60.1
          sed -i 's/^\(.*\)cmake = CMake(self)/# \1cmake = CMake(self)/; s/^\(.*\)cmake.configure()/# \1cmake.configure()/; s/^\(.*\)cmake.build()/# \1cmake.build()\n       pass/' ./conanfile.py
          conan profile new --detect default
          gcc_path=$(which arm-none-eabi-gcc)
          g_path=$(which arm-none-eabi-g++)
          export CC=$gcc_path
          export CXX=$g_path
          
          export CMAKE_C_COMPILER=$gcc_path
          export CMAKE_CXX_COMPILER=$g_path
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan profile update settings.arch=armv8 default
          conan profile update settings.arch_build=armv8 default
          conan create . unum/arm_linux --build=missing
          cd ~/.conan && tar -czvf ustore_deps_arm_linux.tar.gz data/ && \
          mkdir archive/ && mv ustore_deps_arm_linux.tar.gz archive/
